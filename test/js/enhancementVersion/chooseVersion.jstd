TestCase('Choose Enhancement Version', {
    location: travi.location,
    templates: travi.templates,
    cookies: travi.cookies,
    enhancements: travi.enhancements,

    choiceListId: 'versions',

    setUp: function () {
        $('body').append('<footer></footer>');
        sinon.stub(this.location, 'refresh');
        sinon.stub(this.templates, 'get').returns({
            then: function (callback) {
                callback();
            }
        });
        sinon.stub(Modernizr, 'mq');
        sinon.stub(this.cookies, 'create');
        sinon.stub(this.cookies, 'value');
    },

    tearDown: function () {
        travi.test.common.restore([
            this.templates.get,
            this.location.refresh,
            this.cookies.create,
            this.cookies.value,
            Modernizr.mq
        ]);
    },

    'test mobile choice defined as external code expects': function () {
        assertEquals('small', this.enhancements.constants().MOBILE_CHOICE);
    },

    'test desktop choice defined as external code expects': function () {
        assertEquals('large', this.enhancements.constants().DESKTOP_CHOICE);
    },

    'test basic choice defined as external code expects': function () {
        assertEquals('basic', this.enhancements.constants().BASIC_CHOICE);
    },

    'test version toggle links added to page': function () {
        this.enhancements.init();

        var choiceGroupId = 'enhancementVersion',
            choicesExplainationId = 'explainChooseVersion',
            $enhancementChoices = $('#' + this.choiceListId + ' li');

        assertEquals('switch to version', $('#' + choicesExplainationId).text());
        assertEquals(1, $('footer ul').length);

        assertEquals(this.choiceListId, $('footer ul').attr('id'));
        assertEquals(2, $enhancementChoices.length);
        assertEquals(this.enhancements.constants().BASIC_CHOICE, $enhancementChoices.eq(0).text());

        assertEquals(this.enhancements.constants().BASIC_CHOICE + 'Version', $enhancementChoices.eq(0).attr('id'));
        assertEquals(choiceGroupId, $('#' + this.choiceListId).parent().attr('id'));
        assertEquals(choiceGroupId, $('#' + choicesExplainationId).parent().attr('id'));
    },

    'test Mobile link shown when desktop version active': function () {
        this.cookies.value.returns(this.enhancements.constants().DESKTOP_ENHANCEMENT_VERSION);

        this.enhancements.init();

        var $enhancementChoices = $('#' + this.choiceListId + ' li');

        assertEquals('small screen', $enhancementChoices.eq(1).text().trim());
        assertEquals(this.enhancements.constants().MOBILE_CHOICE + 'Version', $enhancementChoices.eq(1).attr('id'));
    },

    'test desktop link shown when mobile version active': function () {
        this.cookies.value.returns(this.enhancements.constants().MOBILE_ENHANCEMENT_VERSION);

        this.enhancements.init();

        var $enhancementChoices = $('#' + this.choiceListId + ' li');

        assertEquals('large screen', $enhancementChoices.eq(1).text().trim());
        assertEquals(this.enhancements.constants().DESKTOP_CHOICE + 'Version', $enhancementChoices.eq(1).attr('id'));
    },

    'test Switch to Desktop version': function () {
        var constants = this.enhancements.constants();
        this.cookies.value.returns(constants.MOBILE_ENHANCEMENT_VERSION);

        this.enhancements.init();
        this.cookies.create.reset();
        this.location.refresh.reset();

        $('#' + constants.DESKTOP_ENHANCEMENT_VERSION + 'Version').click();

        sinon.assert.calledOnce(this.cookies.create);
        sinon.assert.calledWith(
            this.cookies.create,
            constants.ENHANCEMENT_VERSION_KEY,
            constants.DESKTOP_ENHANCEMENT_VERSION,
            constants.DAYS_BEFORE_ENHANCEMENT_COOKIE_EXPIRATION
        );
        sinon.assert.calledOnce(this.location.refresh);

    },

    'test Switch to Mobile version': function () {
        var constants = this.enhancements.constants();
        this.cookies.value.returns(constants.DESKTOP_ENHANCEMENT_VERSION);

        this.enhancements.init();
        this.cookies.create.reset();
        this.location.refresh.reset();

        $('#' + constants.MOBILE_ENHANCEMENT_VERSION + 'Version').click();

        sinon.assert.calledOnce(this.cookies.create);
        sinon.assert.calledWith(
            this.cookies.create,
            constants.ENHANCEMENT_VERSION_KEY,
            constants.MOBILE_ENHANCEMENT_VERSION,
            constants.DAYS_BEFORE_ENHANCEMENT_COOKIE_EXPIRATION
        );
        sinon.assert.calledOnce(this.location.refresh);
    }
});