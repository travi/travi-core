travi.test.testCase("TemplateTests", (function () {
    'use strict';

    var xhrDeferred,
        xhr,
        ajaxSuccess;

    function simulateSuccessfulAjaxResponse() {
        ajaxSuccess(this.templateAsString);
        xhrDeferred.resolve();
    }

    return {
        templates: travi.templates,

        templateName: 'someName',
        pathToTemplate: '/path/to/template',
        templateAsString: 'template',

        setUp: function () {
            xhrDeferred = new $.Deferred();
            xhr = xhrDeferred.promise();

            sinon.stub(jQuery, 'ajax', function (options) {
                ajaxSuccess = options.success;

                return xhr;
            });

            travi.templates.init();
        },

        tearDown: function () {
            travi.test.common.restore([
                jQuery.ajax,
                jQuery.Deferred,
                jQuery.templates,
                this.templates.get,
                this.templates.preLoad
            ]);
            if (jQuery.render[this.templateName]) {
                travi.test.common.restore(jQuery.render[this.templateName]);
            }
        },

        'test pre-loading template requests it from the server, caches it, and returns the promise': function () {
            var promise = this.templates.preLoad(this.templateName, this.pathToTemplate);

            assert.calledWith($.ajax, sinon.match({
                type: 'get',
                dataType: 'text',
                url: this.pathToTemplate
            }));
            assert.same(promise, xhr);
        },

        'test that template is cached after server responds': function () {
            sinon.spy(jQuery, 'templates');
            assert.equals(xhr.state(), 'pending');

            simulateSuccessfulAjaxResponse.call(this);

            this.assertTemplateWasCached(this.templateName, this.templateAsString);
            assert.equals(xhr.state(), 'resolved');
        },

        'test preLoad can accept a list': function () {
            var anotherTemplateName = 'anotherTemplate',
                pathToAnotherTemplate = '/path/to/another/template',
                templates = {};
            templates[this.templateName] = this.pathToTemplate;
            templates[anotherTemplateName] = pathToAnotherTemplate;

            this.templates.preLoad(templates);

            assert.equals(Object.keys(templates).length, $.ajax.callCount);
            assert.equals(this.pathToTemplate, $.ajax.getCall(0).args[0].url);
            assert.equals(pathToAnotherTemplate, $.ajax.getCall(1).args[0].url);
        },

        "test that getting a template by name requests it from the server and returns the promise": function () {
            var promise = travi.templates.get(this.templateName);

            assert.equals(
                '/templates/' + this.templateName + '.tmpl',
                jQuery.ajax.getCall(0).args[0].url
            );

            assert.isObject(promise);
            assert.isFunction(promise.promise);
        },

        "test template is rendered and returned as string": function () {
            var renderedTemplate,
                dataForTemplate = {
                    data: 'something'
                };
            sinon.stub(jQuery.render, this.templateName).returns('renderedTemplate');

            renderedTemplate = travi.templates.render(this.templateName, dataForTemplate);

            this.assertTemplateRenderedWithData(dataForTemplate);
            assert.isString(renderedTemplate);
        },

        'test callback called after template loaded from server': function () {
            var dataForTemplate = {
                    data: 'something'
                },
                callback = sinon.spy(),
                renderedTemplate = 'renderedTemplate';

            this.templates.preLoad(this.templateName);
            simulateSuccessfulAjaxResponse.call(this);

            sinon.stub(jQuery.render, this.templateName).returns(renderedTemplate);

            this.templates.render(this.templateName, dataForTemplate, callback);

            assert.calledOnce($.render[this.templateName]);
            assert.calledWith($.render[this.templateName], dataForTemplate);

            assert.calledOnce(callback);
            assert.calledWith(callback, renderedTemplate);
        },

        'test callback not called when template not loaded': function () {
            var callback = sinon.spy();

            sinon.stub(jQuery.render, this.templateName);

            travi.templates.render(this.templateName, {}, callback);

            refute.called($.render[this.templateName]);
            refute.called(callback);
        },

        "test that template is not requested from server if already cached": function () {
            travi.templates.get(this.templateName);
            $.ajax.reset();

            travi.templates.get(this.templateName);

            refute.called(jQuery.ajax);
        },

        "test that caching does not prevent other templates from loading from server": function () {
            travi.templates.get(this.templateName);
            travi.templates.get('someOtherTemplateName');

            assert.calledTwice(jQuery.ajax);
        },

        'test template can be rendered without data': function () {
            var testCase = this;

            refute.exception(function () {
                testCase.templates.render(testCase.templateName);
            });
        },

        assertTemplateRenderedWithData: function (data) {
            assert(jQuery.render[this.templateName].calledOnce);
            assert.same(data, jQuery.render[this.templateName].getCall(0).args[0]);
        },

        assertTemplateWasCached: function (templateName, templateAsString) {
            assert.calledOnce(jQuery.templates);
            assert.equals(templateName, jQuery.templates.getCall(0).args[0]);
            assert.equals(templateAsString, jQuery.templates.getCall(0).args[1]);
        }
    };
}()));